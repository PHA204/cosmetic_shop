<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <title>Giỏ hàng</title>
</head>
<body>
    <div layout:fragment="content">
        <div class="container">
            <h2 class="fw-bold mb-4">
                <i class="bi bi-cart3"></i> Giỏ hàng của bạn
            </h2>
            
            <div class="row">
                <!-- Cart Items -->
                <div class="col-lg-8 mb-4">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body" id="cartItems">
                            <!-- Loading -->
                            <div class="text-center py-5" id="loading">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                            
                            <!-- Empty Cart -->
                            <div class="text-center py-5 d-none" id="emptyCart">
                                <i class="bi bi-cart-x fs-1 text-muted"></i>
                                <h5 class="mt-3 text-muted">Giỏ hàng trống</h5>
                                <p class="text-muted">Hãy thêm sản phẩm vào giỏ hàng!</p>
                                <a th:href="@{/products}" class="btn btn-primary">
                                    <i class="bi bi-shop"></i> Tiếp tục mua sắm
                                </a>
                            </div>
                            
                            <!-- Cart Items List -->
                            <div id="cartItemsList"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Cart Summary -->
                <div class="col-lg-4">
                    <div class="card border-0 shadow-sm cart-summary sticky-top" style="top: 80px;">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">
                                <i class="bi bi-receipt"></i> Tổng đơn hàng
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="d-flex justify-content-between mb-2">
                                <span>Số sản phẩm:</span>
                                <strong id="totalItems">0</strong>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Tạm tính:</span>
                                <strong id="subtotal">0 ₫</strong>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Phí vận chuyển:</span>
                                <strong class="text-success">Miễn phí</strong>
                            </div>
                            <hr>
                            <div class="d-flex justify-content-between mb-3">
                                <strong>Tổng cộng:</strong>
                                <h4 class="product-price mb-0" id="total">0 ₫</h4>
                            </div>
                            
                            <div class="d-grid gap-2">
                                <button class="btn btn-primary btn-lg" id="checkoutBtn" disabled>
                                    <i class="bi bi-credit-card"></i> Thanh toán
                                </button>
                                <a th:href="@{/products}" class="btn btn-outline-secondary">
                                    <i class="bi bi-arrow-left"></i> Tiếp tục mua sắm
                                </a>
                            </div>
                            
                            <!-- Promotions -->
                            <div class="alert alert-info mt-3 mb-0">
                                <small>
                                    <i class="bi bi-gift"></i>
                                    Miễn phí vận chuyển cho đơn hàng từ 500.000đ
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <th:block layout:fragment="scripts">
        <script>
        $(document).ready(function() {
            loadCart();
            
            // Checkout button
            $('#checkoutBtn').on('click', function() {
                window.location.href = '/checkout';
            });
        });
        
        function loadCart() {
            $('#loading').removeClass('d-none');
            $('#emptyCart').addClass('d-none');
            $('#cartItemsList').empty();
            
            $.ajax({
                url: '/api/cart',
                method: 'GET',
                success: function(response) {
                    $('#loading').addClass('d-none');
                    
                    if (!response.data || !response.data.items || response.data.items.length === 0) {
                        showEmptyCart();
                    } else {
                        renderCartItems(response.data);
                    }
                },
                error: function(xhr) {
                    $('#loading').addClass('d-none');
                    
                    if (xhr.status === 401 || xhr.status === 403) {
                        showMessage('Vui lòng đăng nhập để xem giỏ hàng', 'warning');
                        setTimeout(() => window.location.href = '/login', 1500);
                    } else {
                        showMessage('Không thể tải giỏ hàng', 'danger');
                        showEmptyCart();
                    }
                }
            });
        }
        
        function showEmptyCart() {
            $('#emptyCart').removeClass('d-none');
            $('#cartItemsList').empty();
            updateSummary(0, 0, 0);
            $('#checkoutBtn').prop('disabled', true);
            
            // Update navbar cart count
            if (typeof updateCartCount === 'function') {
                updateCartCount();
            }
        }
        
        function renderCartItems(cart) {
            let html = '';
            
            cart.items.forEach(function(item, index) {
                html += `
                    <div class="cart-item mb-3 pb-3 border-bottom" data-item-id="${item.id}" id="cartItem${item.id}">
                        <div class="row align-items-center">
                            <div class="col-md-2 col-3">
                                <img src="${item.productImage || 'https://via.placeholder.com/100'}" 
                                     alt="${escapeHtml(item.productName)}"
                                     class="img-fluid rounded"
                                     style="width: 100px; height: 100px; object-fit: cover;"
                                     onerror="this.src='https://via.placeholder.com/100'">
                            </div>
                            <div class="col-md-4 col-9">
                                <h6 class="mb-1">${escapeHtml(item.productName)}</h6>
                                <p class="text-muted small mb-0">
                                    Đơn giá: ${formatCurrency(item.productPrice)}
                                </p>
                            </div>
                            <div class="col-md-3 col-8 mt-2 mt-md-0">
                                <div class="input-group input-group-sm">
                                    <button class="btn btn-outline-secondary" 
                                            onclick="updateQuantity(${item.id}, ${item.quantity - 1})"
                                            ${item.quantity <= 1 ? 'disabled' : ''}>
                                        <i class="bi bi-dash"></i>
                                    </button>
                                    <input type="number" class="form-control text-center" 
                                           value="${item.quantity}" min="1" readonly>
                                    <button class="btn btn-outline-secondary" 
                                            onclick="updateQuantity(${item.id}, ${item.quantity + 1})">
                                        <i class="bi bi-plus"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-2 col-3 text-end mt-2 mt-md-0">
                                <strong class="product-price d-block">
                                    ${formatCurrency(item.subTotal)}
                                </strong>
                            </div>
                            <div class="col-md-1 col-1 text-end mt-2 mt-md-0">
                                <button class="btn btn-sm btn-outline-danger" 
                                        onclick="removeItem(${item.id})"
                                        title="Xóa">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            $('#cartItemsList').html(html);
            updateSummary(cart.items.length, cart.totalAmount, cart.totalAmount);
            $('#checkoutBtn').prop('disabled', false);
        }
        
        function updateSummary(itemCount, subtotal, total) {
            $('#totalItems').text(itemCount);
            $('#subtotal').text(formatCurrency(subtotal));
            $('#total').text(formatCurrency(total));
        }
        
        function updateQuantity(itemId, quantity) {
            if (quantity < 1) {
                showMessage('Số lượng phải lớn hơn 0', 'warning');
                return;
            }
            
            // Show loading on the item
            $(`#cartItem${itemId}`).css('opacity', '0.5');
            
            $.ajax({
                url: '/api/cart/items/' + itemId,
                method: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify({ quantity: quantity }),
                success: function() {
                    // Reload cart to get updated data
                    loadCart();
                    showMessage('Đã cập nhật số lượng', 'success');
                    
                    // Update navbar cart count
                    if (typeof updateCartCount === 'function') {
                        updateCartCount();
                    }
                },
                error: function(xhr) {
                    // Restore opacity
                    $(`#cartItem${itemId}`).css('opacity', '1');
                    
                    const msg = xhr.responseJSON?.message || 'Có lỗi xảy ra';
                    showMessage(msg, 'danger');
                    
                    // Reload to sync state
                    setTimeout(() => loadCart(), 1000);
                }
            });
        }
        
        function removeItem(itemId) {
            if (!confirm('Bạn có chắc muốn xóa sản phẩm này khỏi giỏ hàng?')) {
                return;
            }
            
            // Add removing animation
            const itemElement = $(`#cartItem${itemId}`);
            itemElement.addClass('removing');
            
            $.ajax({
                url: '/api/cart/items/' + itemId + '?confirm=true',
                method: 'DELETE',
                success: function() {
                    // Animate removal
                    itemElement.fadeOut(300, function() {
                        $(this).remove();
                        
                        // Reload cart to refresh totals
                        loadCart();
                    });
                    
                    showMessage('Đã xóa sản phẩm khỏi giỏ hàng', 'success');
                    
                    // Update navbar cart count
                    if (typeof updateCartCount === 'function') {
                        updateCartCount();
                    }
                },
                error: function(xhr) {
                    // Remove animation class
                    itemElement.removeClass('removing');
                    
                    const msg = xhr.responseJSON?.message || 'Có lỗi xảy ra';
                    showMessage(msg, 'danger');
                }
            });
        }
        
        function formatCurrency(amount) {
            if (!amount && amount !== 0) return '0 ₫';
            return new Intl.NumberFormat('vi-VN').format(amount) + ' ₫';
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return String(text).replace(/[&<>"']/g, m => map[m]);
        }
        
        function showMessage(message, type) {
            // Remove existing alerts
            $('.alert-notification').remove();
            
            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show position-fixed top-0 end-0 m-3 alert-notification" 
                     role="alert" style="z-index: 9999; min-width: 300px;">
                    <strong>
                        ${type === 'success' ? '<i class="bi bi-check-circle"></i>' : 
                          type === 'danger' ? '<i class="bi bi-x-circle"></i>' : 
                          type === 'warning' ? '<i class="bi bi-exclamation-triangle"></i>' : 
                          '<i class="bi bi-info-circle"></i>'}
                    </strong>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            $('body').append(alertHtml);
            setTimeout(() => $('.alert-notification').fadeOut(), 3000);
        }
        </script>
        
        <style>
        .cart-item.removing {
            opacity: 0.5;
            transition: opacity 0.3s ease;
        }
        
        .cart-item {
            transition: all 0.3s ease;
        }
        
        .cart-summary {
            position: sticky;
            top: 80px;
        }
        
        @media (max-width: 768px) {
            .cart-summary {
                position: relative;
                top: 0;
            }
        }
        </style>
    </th:block>
</body>
</html>