<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <title>Giỏ hàng</title>
</head>
<body>
    <div layout:fragment="content">
        <div class="container">
            <h2 class="fw-bold mb-4">
                <i class="bi bi-cart3"></i> Giỏ hàng của bạn
            </h2>
            
            <div class="row">
                <!-- Cart Items -->
                <div class="col-lg-8 mb-4">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body" id="cartItems">
                            <!-- Loading -->
                            <div class="text-center py-5" id="loading">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                            
                            <!-- Empty Cart -->
                            <div class="text-center py-5 d-none" id="emptyCart">
                                <i class="bi bi-cart-x fs-1 text-muted"></i>
                                <h5 class="mt-3 text-muted">Giỏ hàng trống</h5>
                                <p class="text-muted">Hãy thêm sản phẩm vào giỏ hàng!</p>
                                <a th:href="@{/products}" class="btn btn-primary">
                                    <i class="bi bi-shop"></i> Tiếp tục mua sắm
                                </a>
                            </div>
                            
                            <!-- Cart Items List -->
                            <div id="cartItemsList"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Cart Summary -->
                <div class="col-lg-4">
                    <div class="card border-0 shadow-sm cart-summary">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">
                                <i class="bi bi-receipt"></i> Tổng đơn hàng
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="d-flex justify-content-between mb-2">
                                <span>Tạm tính:</span>
                                <strong id="subtotal">0 ₫</strong>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Phí vận chuyển:</span>
                                <strong class="text-success">Miễn phí</strong>
                            </div>
                            <hr>
                            <div class="d-flex justify-content-between mb-3">
                                <strong>Tổng cộng:</strong>
                                <h4 class="product-price mb-0" id="total">0 ₫</h4>
                            </div>
                            
                            <div class="d-grid gap-2">
                                <button class="btn btn-primary btn-lg" id="checkoutBtn" disabled>
                                    <i class="bi bi-credit-card"></i> Thanh toán
                                </button>
                                <a th:href="@{/products}" class="btn btn-outline-secondary">
                                    <i class="bi bi-arrow-left"></i> Tiếp tục mua sắm
                                </a>
                            </div>
                            
                            <!-- Promotions -->
                            <div class="alert alert-info mt-3 mb-0">
                                <small>
                                    <i class="bi bi-gift"></i>
                                    Miễn phí vận chuyển cho đơn hàng từ 500.000đ
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <th:block layout:fragment="scripts">
        <script>
        $(document).ready(function() {
            loadCart();
            
            // Checkout button
            $('#checkoutBtn').on('click', function() {
                window.location.href = '/checkout';
            });
        });
        
        function loadCart() {
            $.ajax({
                url: '/api/cart',
                method: 'GET',
                success: function(response) {
                    $('#loading').addClass('d-none');
                    
                    if (response.data.items.length === 0) {
                        $('#emptyCart').removeClass('d-none');
                    } else {
                        renderCartItems(response.data);
                    }
                },
                error: function(xhr) {
                    $('#loading').addClass('d-none');
                    showMessage('Không thể tải giỏ hàng', 'danger');
                }
            });
        }
        
        function renderCartItems(cart) {
            let html = '';
            
            cart.items.forEach(function(item) {
                html += `
                    <div class="cart-item mb-3 pb-3 border-bottom">
                        <div class="row align-items-center">
                            <div class="col-md-2">
                                <img src="${item.productImage}" 
                                     alt="${item.productName}"
                                     class="img-fluid rounded"
                                     onerror="this.src='https://via.placeholder.com/100'">
                            </div>
                            <div class="col-md-4">
                                <h6 class="mb-1">${item.productName}</h6>
                                <p class="text-muted small mb-0">
                                    ${formatCurrency(item.productPrice)}
                                </p>
                            </div>
                            <div class="col-md-3">
                                <div class="input-group input-group-sm">
                                    <button class="btn btn-outline-secondary" 
                                            onclick="updateQuantity(${item.id}, ${item.quantity - 1})">
                                        <i class="bi bi-dash"></i>
                                    </button>
                                    <input type="number" class="form-control text-center" 
                                           value="${item.quantity}" min="1" readonly>
                                    <button class="btn btn-outline-secondary" 
                                            onclick="updateQuantity(${item.id}, ${item.quantity + 1})">
                                        <i class="bi bi-plus"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-2 text-end">
                                <strong class="product-price">
                                    ${formatCurrency(item.subTotal)}
                                </strong>
                            </div>
                            <div class="col-md-1 text-end">
                                <button class="btn btn-sm btn-outline-danger" 
                                        onclick="removeItem(${item.id})">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            $('#cartItemsList').html(html);
            $('#subtotal').text(formatCurrency(cart.totalAmount));
            $('#total').text(formatCurrency(cart.totalAmount));
            $('#checkoutBtn').prop('disabled', false);
        }
        
        function updateQuantity(itemId, quantity) {
            if (quantity < 1) return;
            
            $.ajax({
                url: '/api/cart/items/' + itemId,
                method: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify({ quantity: quantity }),
                success: function() {
                    loadCart();
                    showMessage('Cập nhật thành công', 'success');
                },
                error: function(xhr) {
                    const msg = xhr.responseJSON?.message || 'Có lỗi xảy ra';
                    showMessage(msg, 'danger');
                }
            });
        }
        
        function removeItem(itemId) {
            if (!confirm('Bạn có chắc muốn xóa sản phẩm này?')) return;
            
            $.ajax({
                url: '/api/cart/items/' + itemId + '?confirm=true',
                method: 'DELETE',
                success: function() {
                    loadCart();
                    showMessage('Đã xóa sản phẩm', 'success');
                },
                error: function(xhr) {
                    const msg = xhr.responseJSON?.message || 'Có lỗi xảy ra';
                    showMessage(msg, 'danger');
                }
            });
        }
        
        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN').format(amount) + ' ₫';
        }
        
        function showMessage(message, type) {
            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show position-fixed top-0 end-0 m-3" 
                     role="alert" style="z-index: 9999;">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            $('body').append(alertHtml);
            setTimeout(() => $('.alert').fadeOut(), 3000);
        }
        </script>
    </th:block>
</body>
</html>