<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{admin-layout}">
<head>
    <title>Quản Lý Người Dùng - Admin</title>
</head>
<body>
    <div layout:fragment="content">
        <div class="container-fluid mt-4">
            <!-- Header -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h2><i class="bi bi-people text-primary"></i> Quản Lý Người Dùng</h2>
                            <p class="text-muted mb-0">Xem thông tin người dùng và thống kê</p>
                        </div>
                        <button class="btn btn-outline-primary" onclick="loadUsers()">
                            <i class="bi bi-arrow-clockwise"></i> Làm mới
                        </button>
                    </div>
                </div>
            </div>

            <!-- Statistics Cards -->
            <div class="row g-3 mb-4">
                <div class="col-md-3">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="text-muted mb-1">Tổng Người Dùng</h6>
                                    <h3 class="mb-0" id="totalUsers">0</h3>
                                </div>
                                <div class="bg-primary bg-opacity-10 rounded p-3">
                                    <i class="bi bi-people text-primary fs-3"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="text-muted mb-1">Admin</h6>
                                    <h3 class="mb-0" id="totalAdmins">0</h3>
                                </div>
                                <div class="bg-success bg-opacity-10 rounded p-3">
                                    <i class="bi bi-shield-check text-success fs-3"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="text-muted mb-1">Người Dùng Thường</h6>
                                    <h3 class="mb-0" id="totalRegularUsers">0</h3>
                                </div>
                                <div class="bg-info bg-opacity-10 rounded p-3">
                                    <i class="bi bi-person text-info fs-3"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="text-muted mb-1">Mới Tuần Này</h6>
                                    <h3 class="mb-0" id="newUsersThisWeek">0</h3>
                                </div>
                                <div class="bg-warning bg-opacity-10 rounded p-3">
                                    <i class="bi bi-person-plus text-warning fs-3"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filters -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-5">
                            <label class="form-label">Tìm kiếm</label>
                            <input type="text" class="form-control" id="searchInput" placeholder="Tìm theo tên, email, số điện thoại...">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Vai trò</label>
                            <select class="form-select" id="roleFilter">
                                <option value="">Tất cả</option>
                                <option value="USER">USER</option>
                                <option value="ADMIN">ADMIN</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">&nbsp;</label>
                            <div class="d-flex gap-2">
                                <button class="btn btn-primary w-100" onclick="applyFilters()">
                                    <i class="bi bi-search"></i> Tìm kiếm
                                </button>
                                <button class="btn btn-outline-secondary" onclick="resetFilters()">
                                    <i class="bi bi-arrow-clockwise"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Users Table -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0 py-3">
                    <h5 class="mb-0">Danh Sách Người Dùng</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 80px;">ID</th>
                                    <th>Username</th>
                                    <th>Họ Tên</th>
                                    <th>Email</th>
                                    <th>Số Điện Thoại</th>
                                    <th>Vai Trò</th>
                                    <th>Ngày Tạo</th>
                                    <th style="width: 120px;">Thao Tác</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <tr>
                                    <td colspan="8" class="text-center py-5">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer bg-white border-0">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <span class="text-muted" id="showingInfo">Đang tải...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- User Detail Modal -->
        <div class="modal fade" id="userDetailModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="bi bi-person-circle"></i> Thông Tin Chi Tiết
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <!-- User Info -->
                            <div class="col-md-6 mb-3">
                                <div class="card h-100">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0"><i class="bi bi-info-circle"></i> Thông Tin Cơ Bản</h6>
                                    </div>
                                    <div class="card-body">
                                        <table class="table table-sm table-borderless mb-0">
                                            <tr>
                                                <td class="text-muted" style="width: 140px;">ID:</td>
                                                <td class="fw-bold" id="detailUserId"></td>
                                            </tr>
                                            <tr>
                                                <td class="text-muted">Username:</td>
                                                <td id="detailUsername"></td>
                                            </tr>
                                            <tr>
                                                <td class="text-muted">Họ tên:</td>
                                                <td id="detailFullName"></td>
                                            </tr>
                                            <tr>
                                                <td class="text-muted">Email:</td>
                                                <td id="detailEmail"></td>
                                            </tr>
                                            <tr>
                                                <td class="text-muted">Số điện thoại:</td>
                                                <td id="detailPhone"></td>
                                            </tr>
                                            <tr>
                                                <td class="text-muted">Vai trò:</td>
                                                <td id="detailRole"></td>
                                            </tr>
                                            <tr>
                                                <td class="text-muted">Ngày tạo:</td>
                                                <td id="detailCreatedAt"></td>
                                            </tr>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <!-- Address Info -->
                            <div class="col-md-6 mb-3">
                                <div class="card h-100">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0"><i class="bi bi-geo-alt"></i> Địa Chỉ</h6>
                                    </div>
                                    <div class="card-body">
                                        <p id="detailAddress" class="mb-0"></p>
                                    </div>
                                </div>
                            </div>

                            <!-- Order Statistics -->
                            <div class="col-12 mb-3">
                                <div class="card">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0"><i class="bi bi-bar-chart"></i> Thống Kê Đơn Hàng</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row text-center">
                                            <div class="col-md-3">
                                                <div class="border rounded p-3">
                                                    <h4 class="text-primary mb-1" id="userTotalOrders">0</h4>
                                                    <small class="text-muted">Tổng Đơn</small>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="border rounded p-3">
                                                    <h4 class="text-success mb-1" id="userCompletedOrders">0</h4>
                                                    <small class="text-muted">Đã Giao</small>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="border rounded p-3">
                                                    <h4 class="text-warning mb-1" id="userPendingOrders">0</h4>
                                                    <small class="text-muted">Đang Xử Lý</small>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="border rounded p-3">
                                                    <h4 class="text-danger mb-1" id="userTotalSpending">0₫</h4>
                                                    <small class="text-muted">Tổng Chi</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <th:block layout:fragment="scripts">
        <script th:inline="javascript">
            // Note: This page would need new API endpoints for user management
            // For now, we'll use mock data and existing endpoints where possible

            let users = [];
            let filteredUsers = [];

            $(document).ready(function() {
                loadUsers();

                // Search on Enter
                $('#searchInput').on('keypress', function(e) {
                    if (e.which === 13) {
                        applyFilters();
                    }
                });
            });

            function loadUsers() {
                // Mock data since we don't have a users API endpoint
                // In production, you would call: $.get('/api/admin/users', ...)
                
                users = generateMockUsers(50);
                filteredUsers = [...users];
                
                displayUsers();
                updateStatistics();
            }

            function generateMockUsers(count) {
                const mockUsers = [];
                const firstNames = ['Nguyễn', 'Trần', 'Lê', 'Phạm', 'Hoàng', 'Phan', 'Vũ', 'Đặng', 'Bùi', 'Đỗ'];
                const lastNames = ['Văn', 'Thị', 'Minh', 'Hồng', 'Quốc', 'Thu', 'Anh', 'Tuấn', 'Linh', 'Hương'];
                const midNames = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'K', 'L'];

                for (let i = 1; i <= count; i++) {
                    const firstName = firstNames[Math.floor(Math.random() * firstNames.length)];
                    const lastName = lastNames[Math.floor(Math.random() * lastNames.length)];
                    const midName = midNames[Math.floor(Math.random() * midNames.length)];
                    const fullName = `${firstName} ${lastName} ${midName}`;
                    const username = `user${i}`;
                    const role = i <= 3 ? 'ADMIN' : 'USER';
                    
                    mockUsers.push({
                        id: i,
                        username: username,
                        fullName: fullName,
                        email: `${username}@example.com`,
                        phone: `09${Math.floor(Math.random() * 100000000)}`,
                        address: `${Math.floor(Math.random() * 500) + 1} Đường ABC, Quận ${Math.floor(Math.random() * 12) + 1}, TP.HCM`,
                        role: role,
                        createdAt: new Date(2024, Math.floor(Math.random() * 12), Math.floor(Math.random() * 28) + 1).toISOString()
                    });
                }

                return mockUsers;
            }

            function displayUsers() {
                let html = '';

                if (filteredUsers.length === 0) {
                    html = '<tr><td colspan="8" class="text-center py-4 text-muted">Không tìm thấy người dùng nào</td></tr>';
                } else {
                    filteredUsers.forEach(user => {
                        const roleBadge = user.role === 'ADMIN' 
                            ? '<span class="badge bg-danger"><i class="bi bi-shield-check"></i> ADMIN</span>'
                            : '<span class="badge bg-primary"><i class="bi bi-person"></i> USER</span>';
                        
                        html += `
                            <tr>
                                <td><strong>#${user.id}</strong></td>
                                <td>${escapeHtml(user.username)}</td>
                                <td>${escapeHtml(user.fullName)}</td>
                                <td><small>${escapeHtml(user.email)}</small></td>
                                <td>${escapeHtml(user.phone)}</td>
                                <td>${roleBadge}</td>
                                <td><small>${formatDate(user.createdAt)}</small></td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary" onclick="viewUserDetail(${user.id})">
                                        <i class="bi bi-eye"></i> Xem
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                }

                $('#usersTableBody').html(html);
                $('#showingInfo').text(`Hiển thị ${filteredUsers.length} người dùng`);
            }

            function updateStatistics() {
                const total = users.length;
                const admins = users.filter(u => u.role === 'ADMIN').length;
                const regularUsers = users.filter(u => u.role === 'USER').length;
                
                // Mock: New users this week (last 7 days)
                const oneWeekAgo = new Date();
                oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
                const newUsers = users.filter(u => new Date(u.createdAt) >= oneWeekAgo).length;

                $('#totalUsers').text(total);
                $('#totalAdmins').text(admins);
                $('#totalRegularUsers').text(regularUsers);
                $('#newUsersThisWeek').text(newUsers);
            }

            function applyFilters() {
                const search = $('#searchInput').val().toLowerCase().trim();
                const role = $('#roleFilter').val();

                filteredUsers = users.filter(user => {
                    const matchSearch = !search || 
                        user.username.toLowerCase().includes(search) ||
                        user.fullName.toLowerCase().includes(search) ||
                        user.email.toLowerCase().includes(search) ||
                        user.phone.includes(search);
                    
                    const matchRole = !role || user.role === role;

                    return matchSearch && matchRole;
                });

                displayUsers();
            }

            function resetFilters() {
                $('#searchInput').val('');
                $('#roleFilter').val('');
                filteredUsers = [...users];
                displayUsers();
            }

            function viewUserDetail(userId) {
                const user = users.find(u => u.id === userId);
                if (!user) return;

                // Display user basic info
                $('#detailUserId').text(user.id);
                $('#detailUsername').text(user.username);
                $('#detailFullName').text(user.fullName);
                $('#detailEmail').text(user.email);
                $('#detailPhone').text(user.phone);
                $('#detailAddress').text(user.address);
                
                const roleBadge = user.role === 'ADMIN' 
                    ? '<span class="badge bg-danger"><i class="bi bi-shield-check"></i> ADMIN</span>'
                    : '<span class="badge bg-primary"><i class="bi bi-person"></i> USER</span>';
                $('#detailRole').html(roleBadge);
                $('#detailCreatedAt').text(formatDateTime(user.createdAt));

                // Mock order statistics
                const totalOrders = Math.floor(Math.random() * 50);
                const completedOrders = Math.floor(totalOrders * 0.7);
                const pendingOrders = totalOrders - completedOrders;
                const totalSpending = Math.floor(Math.random() * 50000000) + 1000000;

                $('#userTotalOrders').text(totalOrders);
                $('#userCompletedOrders').text(completedOrders);
                $('#userPendingOrders').text(pendingOrders);
                $('#userTotalSpending').text(formatCurrency(totalSpending));

                $('#userDetailModal').modal('show');
            }
        </script>
    </th:block>
</body>
</html>